// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// =============================================================================
// REALTIME CONFIGURATION
// =============================================================================
// ALL TABLES in this schema are configured for Supabase Realtime to provide
// instant UI updates across the application. This is managed by:
// - Post-migration hook: apps/backend/prisma/migrations/post-migrate.sql
// - Seed script: apps/backend/prisma/seed.ts (enableRealtimeForAllTables)
//
// Benefits:
// - Instant UI updates without manual refresh
// - Real-time collaboration features
// - Consistent user experience across all data changes
// =============================================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // PgBouncer pooled connection (port 6543) for runtime
  directUrl = env("DIRECT_DATABASE_URL") // Direct Postgres connection (port 5432) for migrations
}

// =============================================================================
// ENUMS
// =============================================================================
enum ProjectStatus {
  active
  completed
  cancelled
  on_hold
  archived
  deleted
}

enum ExtractionResultStatus {
  pending
  accepted
  rejected
  edited
}

// =============================================================================
// ORGANIZATIONS
// =============================================================================
model Organization {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  description String?
  meta        Json     @default("{}") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  roles             Role[]
  members           OrganizationMember[]
  invitations       Invitation[]
  clients           Client[]
  projects          Project[]
  dataLayers        DataLayer[]
  extractionJobs    ExtractionJob[]
  extractionSchemas ExtractionSchema[]
  suppliers         Supplier[]

  @@index([slug])
  @@index([createdAt])
  @@map("organizations")
}

// =============================================================================
// USERS (extends auth.users with profile info)
// =============================================================================
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  avatarUrl String?  @map("avatar_url")
  phone     String?
  timezone  String   @default("UTC")
  meta      Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organizationMemberships   OrganizationMember[]
  sentInvitations           Invitation[]         @relation("InvitationSender")
  acceptedInvitations       Invitation[]         @relation("InvitationAccepter")
  initiatedExtractionJobs   ExtractionJob[]
  editedExtractionResults   ExtractionResult[]   @relation("ExtractionResultEditor")
  verifiedExtractionResults ExtractionResult[]   @relation("ExtractionResultVerifier")
  selectedSupplierMatches   SupplierMatch[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

// =============================================================================
// ROLES (Simplified RBAC System)
// =============================================================================
model Role {
  id             String   @id @default(uuid()) @db.Uuid
  name           String
  slug           String
  description    String?
  isSystem       Boolean  @default(false) @map("is_system")
  organizationId String?  @map("organization_id") @db.Uuid
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      OrganizationMember[]
  invitations  Invitation[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@map("roles")
}

// =============================================================================
// ORGANIZATION MEMBERS
// =============================================================================
model OrganizationMember {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  roleId         String   @map("role_id") @db.Uuid
  status         String   @default("active")
  joinedAt       DateTime @default(now()) @map("joined_at") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([roleId])
  @@index([status])
  @@map("organization_members")
}

// =============================================================================
// INVITATIONS
// =============================================================================
model Invitation {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  email          String
  roleId         String    @map("role_id") @db.Uuid
  invitedBy      String    @map("invited_by") @db.Uuid
  token          String    @unique @default(uuid())
  status         String    @default("pending")
  expiresAt      DateTime  @map("expires_at") @db.Timestamptz(6)
  acceptedAt     DateTime? @map("accepted_at") @db.Timestamptz(6)
  acceptedBy     String?   @map("accepted_by") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)
  inviter      User         @relation("InvitationSender", fields: [invitedBy], references: [id], onDelete: Cascade)
  accepter     User?        @relation("InvitationAccepter", fields: [acceptedBy], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

// =============================================================================
// CLIENTS
// =============================================================================
model Client {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  name           String
  description    String?
  contactName    String?  @map("contact_name")
  contactEmail   String?  @map("contact_email")
  contactPhone   String?  @map("contact_phone")
  address        Json?    @db.JsonB
  meta           Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]

  @@index([organizationId])
  @@index([name])
  @@index([contactEmail])
  @@map("clients")
}

// =============================================================================
// PROJECTS (Simplified)
// =============================================================================
model Project {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  clientId       String        @map("client_id") @db.Uuid
  name           String
  description    String?
  status         ProjectStatus @default(active)
  location       Json?         @db.JsonB
  meta           Json          @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  dataLayers   DataLayer[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@map("projects")
}

// =============================================================================
// DATA LAYERS (ingested files)
// =============================================================================
model DataLayer {
  id               String    @id @default(uuid()) @db.Uuid
  organizationId   String    @map("organization_id") @db.Uuid
  projectId        String    @map("project_id") @db.Uuid
  name             String
  description      String?
  fileType         String    @map("file_type")
  filePath         String    @map("file_path")
  fileSize         BigInt?   @map("file_size")
  fileHash         String?   @map("file_hash")
  sourceType       String    @default("upload") @map("source_type")
  sourceMetadata   Json      @default("{}") @map("source_metadata") @db.JsonB
  processingStatus String    @default("pending") @map("processing_status")
  processingError  String?   @map("processing_error")
  processedAt      DateTime? @map("processed_at") @db.Timestamptz(6)
  parentId         String?   @map("parent_id") @db.Uuid
  meta             Json      @default("{}")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                 Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent                  DataLayer?               @relation("DataLayerHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children                DataLayer[]              @relation("DataLayerHierarchy")
  extractionJobDataLayers ExtractionJobDataLayer[]

  @@index([organizationId])
  @@index([projectId])
  @@index([fileType])
  @@index([fileHash])
  @@index([processingStatus])
  @@index([parentId])
  @@map("data_layers")
}

// =============================================================================
// EXTRACTION JOBS (Simplified with results as JSON)
// =============================================================================
model ExtractionJob {
  id                 String    @id @default(uuid()) @db.Uuid
  organizationId     String    @map("organization_id") @db.Uuid
  initiatedBy        String    @map("initiated_by") @db.Uuid
  jobType            String    @default("material_extraction") @map("job_type")
  status             String    @default("queued")
  progressPercentage Int       @default(0) @map("progress_percentage")
  startedAt          DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt        DateTime? @map("completed_at") @db.Timestamptz(6)
  errorMessage       String?   @map("error_message")
  config             Json      @default("{}") @db.JsonB

  // STRICT SCHEMA-DRIVEN: Reference to registered schema (required)
  schemaId String @map("schema_id") @db.Uuid

  // Snapshotted compiled schema from the referenced schema
  compiledJsonSchema Json @default("{}") @map("compiled_json_schema") @db.JsonB

  meta      Json     @default("{}") @db.JsonB
  logs      Json     @default("[]") @db.JsonB // Array of log messages with timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  initiator               User                     @relation(fields: [initiatedBy], references: [id], onDelete: Cascade)
  schema                  ExtractionSchema         @relation(fields: [schemaId], references: [id], onDelete: Restrict)
  extractionResults       ExtractionResult[]
  extractionJobDataLayers ExtractionJobDataLayer[]

  @@index([organizationId])
  @@index([initiatedBy])
  @@index([status])
  @@index([jobType])
  @@index([schemaId])
  @@map("extraction_jobs")
}

// Junction table for many-to-many relationship between ExtractionJob and DataLayer
model ExtractionJobDataLayer {
  id              String   @id @default(uuid()) @db.Uuid
  extractionJobId String   @map("extraction_job_id") @db.Uuid
  dataLayerId     String   @map("data_layer_id") @db.Uuid
  processingOrder Int      @default(0) @map("processing_order") // Order in which files should be processed
  status          String   @default("pending") // pending, processing, completed, failed
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  extractionJob ExtractionJob @relation(fields: [extractionJobId], references: [id], onDelete: Cascade)
  dataLayer     DataLayer     @relation(fields: [dataLayerId], references: [id], onDelete: Cascade)

  @@unique([extractionJobId, dataLayerId])
  @@index([extractionJobId])
  @@index([dataLayerId])
  @@map("extraction_job_data_layers")
}

// =============================================================================
// EXTRACTION RESULTS (Enhanced with evidence and human verification)
// =============================================================================
model ExtractionResult {
  id              String @id @default(uuid()) @db.Uuid
  extractionJobId String @map("extraction_job_id") @db.Uuid

  // Structured extraction data from LLM (already parsed JSON)
  rawExtraction Json @map("raw_extraction") @db.JsonB

  // Validation errors from schema validation (if any)
  validationErrors Json? @map("validation_errors") @db.JsonB

  // Evidence of where the data came from
  evidence Json @default("{}") @map("evidence") @db.JsonB

  // Human-verified version (starts as copy of parsedExtraction, can be edited)
  verifiedData Json? @map("verified_data") @db.JsonB

  // Agent execution metadata tracking which agents processed this result
  agentExecutionMetadata Json @default("[]") @map("agent_execution_metadata") @db.JsonB

  // Metadata fields for performance and querying
  status          ExtractionResultStatus @default(pending)
  confidenceScore Float?                 @map("confidence_score")
  pageNumber      Int?                   @map("page_number")

  // Human verification tracking
  verifiedBy        String?   @map("verified_by") @db.Uuid
  verifiedAt        DateTime? @map("verified_at") @db.Timestamptz(6)
  verificationNotes String?   @map("verification_notes")

  // Audit fields
  editedBy  String?   @map("edited_by") @db.Uuid
  editedAt  DateTime? @map("edited_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  extractionJob   ExtractionJob   @relation(fields: [extractionJobId], references: [id], onDelete: Cascade)
  editor          User?           @relation("ExtractionResultEditor", fields: [editedBy], references: [id], onDelete: SetNull)
  verifier        User?           @relation("ExtractionResultVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)
  supplierMatches SupplierMatch[]

  @@index([extractionJobId])
  @@index([status])
  @@index([confidenceScore])
  @@index([pageNumber])
  @@index([verifiedBy])
  @@index([createdAt])
  // Add GIN index for flexible JSONB querying on all JSON fields
  @@index([rawExtraction], type: Gin)
  @@index([evidence], type: Gin)
  @@index([verifiedData], type: Gin)
  @@map("extraction_results")
}

// =============================================================================
// EXTRACTION SCHEMAS (Schema-driven extraction definitions)
// =============================================================================
model ExtractionSchema {
  id             String @id @default(uuid()) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid

  // Permanent identifier for this schema across all versions
  // 12-character alphanumeric string that never changes
  schemaIdentifier String @map("schema_identifier")

  // Name can be changed across versions
  name               String
  version            Int
  definition         Json    @db.JsonB
  compiledJsonSchema Json    @map("compiled_json_schema") @db.JsonB
  prompt             String? @db.Text
  examples           Json?   @db.JsonB

  // Post-processing agents for transforming extraction results
  agents Json @default("[]") @db.JsonB

  // Track changes between versions
  changeDescription String? @map("change_description")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  extractionJobs ExtractionJob[]

  // Unique constraint: identifier + version (within org)
  @@unique([organizationId, schemaIdentifier, version])
  // Indexes for efficient queries
  @@index([organizationId])
  @@index([schemaIdentifier])
  @@index([name])
  @@map("extraction_schemas")
}

// =============================================================================
// SUPPLIERS (Vendor management for material procurement)
// =============================================================================
model Supplier {
  id             String  @id @default(uuid()) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  name           String
  contactName    String? @map("contact_name")
  contactEmail   String  @map("contact_email")
  contactPhone   String? @map("contact_phone")
  address        Json?   @db.JsonB

  // Materials and capabilities
  materialsOffered Json @default("[]") @map("materials_offered") @db.JsonB

  meta      Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  matches      SupplierMatch[]

  @@index([organizationId])
  @@index([contactEmail])
  @@index([materialsOffered], type: Gin)
  @@map("suppliers")
}

// =============================================================================
// SUPPLIER MATCHES (LLM-powered matching between extraction results and suppliers)
// =============================================================================
model SupplierMatch {
  id                 String @id @default(uuid()) @db.Uuid
  extractionResultId String @map("extraction_result_id") @db.Uuid
  supplierId         String @map("supplier_id") @db.Uuid

  // Match metadata
  confidenceScore Float?  @map("confidence_score")
  matchReason     String? @map("match_reason") @db.Text
  matchMetadata   Json    @default("{}") @map("match_metadata") @db.JsonB

  // User selection
  isSelected Boolean   @default(false) @map("is_selected")
  selectedBy String?   @map("selected_by") @db.Uuid
  selectedAt DateTime? @map("selected_at") @db.Timestamptz(6)

  // Email tracking
  emailSent   Boolean   @default(false) @map("email_sent")
  emailSentAt DateTime? @map("email_sent_at") @db.Timestamptz(6)

  meta      Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  extractionResult ExtractionResult @relation(fields: [extractionResultId], references: [id], onDelete: Cascade)
  supplier         Supplier         @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  selector         User?            @relation(fields: [selectedBy], references: [id], onDelete: SetNull)

  @@unique([extractionResultId, supplierId])
  @@index([extractionResultId])
  @@index([supplierId])
  @@index([isSelected])
  @@index([confidenceScore])
  @@map("supplier_matches")
}

// =============================================================================
// AUDIT LOGS (Minimal audit logging for critical changes)
// =============================================================================
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  occurredAt DateTime @default(now()) @map("occurred_at") @db.Timestamptz(6)

  // Actor information
  actorUserId String? @map("actor_user_id") @db.Uuid
  actorOrgId  String? @map("actor_org_id") @db.Uuid
  actorEmail  String? @map("actor_email")

  // Target information
  targetTable String  @map("target_table")
  targetId    String? @map("target_id")

  // Operation details
  action String // "create" | "update" | "delete" | "upsert"
  before Json?  @db.JsonB
  after  Json?  @db.JsonB

  // Optional metadata for debugging
  correlationId String? @map("correlation_id")
  ipAddress     String? @map("ip_address")
  userAgent     String? @map("user_agent")

  // Note: No foreign key constraints to preserve audit logs even if users/orgs are deleted
  // This is a common pattern in audit systems for data preservation

  @@index([actorOrgId, occurredAt])
  @@index([targetTable, targetId])
  @@index([actorUserId])
  @@index([correlationId])
  @@map("audit_logs")
}
