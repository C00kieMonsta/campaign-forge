name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  changes:
    name: Determine Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      utils: ${{ steps.filter.outputs.utils }}
      database: ${{ steps.filter.outputs.database }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            apps/backend/**
            apps/frontend/**
            packages/utils/**
            packages/types/**
            packages/core-client/**
            apps/backend/prisma/schema.prisma
            apps/backend/prisma/seed.ts
            apps/backend/prisma/migrations/**

      - name: Set outputs
        id: filter
        run: |
          if [[ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]]; then
            if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "apps/backend|packages/(types|utils|core-client)|prisma"; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "apps/frontend|packages/(utils|types|core-client)"; then
              echo "frontend=true" >> $GITHUB_OUTPUT
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -q "packages/utils"; then
              echo "utils=true" >> $GITHUB_OUTPUT
            else
              echo "utils=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "apps/backend/prisma"; then
              echo "database=true" >> $GITHUB_OUTPUT
            else
              echo "database=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "utils=false" >> $GITHUB_OUTPUT
            echo "database=false" >> $GITHUB_OUTPUT
          fi

  test-backend:
    name: Test Backend (if changed)
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.utils == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: true
    defaults:
      run:
        working-directory: ./apps/backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build workspace packages
        uses: ./.github/actions/build-packages

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Run type check
        run: pnpm run type-check

      - name: Run backend tests
        run: pnpm test

  test-frontend:
    name: Test Frontend (if changed)
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.utils == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build workspace packages
        uses: ./.github/actions/build-packages

      - name: Run type check
        run: pnpm run type-check

      - name: Run frontend tests
        run: pnpm test

      - name: Build frontend
        uses: ./.github/actions/build-frontend
        with:
          vite_api_url: http://localhost:8001
          vite_ws_url: ws://localhost:8001/ws
          vite_supabase_url: http://127.0.0.1:54321
          vite_supabase_anon_key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
          vite_stage: production

  test-utils:
    name: Test Utils (if changed)
    needs: changes
    if: needs.changes.outputs.utils == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
    defaults:
      run:
        working-directory: ./packages/utils
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Run type check
        run: cd ../.. && pnpm run type-check

      - name: Run utils tests
        run: pnpm test

      - name: Build package
        run: pnpm run build

      - name: Verify build output
        run: |
          echo "Checking utils build output..."
          if [ ! -f "dist/index.js" ]; then
            echo "‚ùå ERROR: Utils package not built correctly!"
            exit 1
          fi
          echo "‚úÖ Utils package built successfully!"

  test-database:
    name: Test Database Migrations (if changed)
    needs: changes
    if: needs.changes.outputs.database == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local
        run: |
          echo "üöÄ Starting local Supabase instance for testing..."
          supabase start

      - name: Validate migration sequence
        run: |
          echo "üîÑ Testing full migration reset..."
          supabase db reset --debug

      - name: Check database schema
        run: |
          echo "üîç Inspecting database schema..."
          supabase db dump --local -s public

      - name: Run basic data validation
        run: |
          echo "üß™ Running basic data validation..."
          psql postgresql://postgres:postgres@127.0.0.1:54322/postgres -c "
            SELECT 
              schemaname, 
              tablename, 
              tableowner 
            FROM pg_tables 
            WHERE schemaname = 'public' 
            ORDER BY tablename;" || echo "‚ö†Ô∏è Could not query tables"

          # Check that essential tables exist (if they should)
          echo "üìä Checking essential tables..."
          psql postgresql://postgres:postgres@127.0.0.1:54322/postgres -c "
            SELECT COUNT(*) as user_count FROM users;
            SELECT COUNT(*) as org_count FROM organizations;
            SELECT COUNT(*) as role_count FROM roles;
            SELECT COUNT(*) as permission_count FROM permissions;" || echo "‚ö†Ô∏è Some tables may not exist yet"

      - name: Test RLS policies
        run: |
          echo "üîê Testing Row Level Security policies..."
          psql postgresql://postgres:postgres@127.0.0.1:54322/postgres -c "
            SELECT COUNT(*) as policy_count
            FROM pg_policies 
            WHERE schemaname = 'public';" || echo "‚ö†Ô∏è Could not query policies"

      - name: Check functions and triggers
        run: |
          echo "‚öôÔ∏è Checking database functions and triggers..."
          psql postgresql://postgres:postgres@127.0.0.1:54322/postgres -c "
            SELECT COUNT(*) as function_count
            FROM information_schema.routines 
            WHERE routine_schema = 'public';" || echo "‚ö†Ô∏è Could not query functions"

      - name: Stop Supabase
        if: always()
        run: |
          echo "üõë Stopping Supabase..."
          supabase stop

  # Summary job that depends on all test jobs
  pr-checks-complete:
    name: PR Checks Complete
    needs: [changes, test-backend, test-frontend, test-utils, test-database]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          echo "üìä PR Check Results:"
          echo "Backend changed: ${{ needs.changes.outputs.backend }}"
          echo "Frontend changed: ${{ needs.changes.outputs.frontend }}"
          echo "Utils changed: ${{ needs.changes.outputs.utils }}"
          echo "Database changed: ${{ needs.changes.outputs.database }}"
          echo ""
          if [[ "${{ needs.test-backend.result }}" == "failure" ]] || [[ "${{ needs.test-frontend.result }}" == "failure" ]] || [[ "${{ needs.test-utils.result }}" == "failure" ]] || [[ "${{ needs.test-database.result }}" == "failure" ]]; then
            echo "‚ùå Some tests failed"
            exit 1
          else
            echo "‚úÖ All applicable tests passed"
          fi
