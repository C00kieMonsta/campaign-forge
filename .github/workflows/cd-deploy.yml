name: Deploy Application

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
      deploy_landing:
        description: "Deploy landing site"
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: "Deploy admin frontend"
        required: false
        default: true
        type: boolean
      deploy_backend:
        description: "Deploy backend to EC2"
        required: false
        default: true
        type: boolean

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-north-1

jobs:
  # â”€â”€â”€ Landing Site â†’ S3 + CloudFront â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-landing:
    name: Deploy Landing Site
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_landing != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build landing site
        run: pnpm --filter landing build
        env:
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_S3 }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_S3 }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy landing to S3
        run: |
          S3_BUCKET="${{ vars.LANDING_S3_BUCKET }}"

          if [ -z "$S3_BUCKET" ]; then
            echo "âš ï¸ LANDING_S3_BUCKET not set, skipping"
            exit 0
          fi

          echo "ğŸ“¦ Deploying to s3://${S3_BUCKET}"

          # Versioned assets: long-lived cache
          aws s3 sync apps/landing/dist "s3://${S3_BUCKET}" \
            --delete \
            --region "${{ env.AWS_REGION }}" \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # HTML: always revalidate
          aws s3 cp apps/landing/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --region "${{ env.AWS_REGION }}" \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8"

          echo "âœ… Landing uploaded"

      - name: Invalidate CloudFront
        run: |
          DIST_ID="${{ vars.LANDING_CF_DISTRIBUTION }}"
          if [ -z "$DIST_ID" ]; then
            echo "âš ï¸ LANDING_CF_DISTRIBUTION not set, skipping"
            exit 0
          fi
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*" --region us-east-1
          echo "âœ… CloudFront invalidated"

  # â”€â”€â”€ Admin Frontend â†’ S3 + CloudFront â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Admin Frontend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_frontend != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build workspace packages
        uses: ./.github/actions/build-packages

      - name: Build admin frontend
        run: pnpm --filter @apps/frontend build
        env:
          VITE_API_URL: ${{ vars.API_BASE_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_S3 }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_S3 }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy admin to S3
        run: |
          S3_BUCKET="${{ vars.ADMIN_S3_BUCKET }}"

          if [ -z "$S3_BUCKET" ]; then
            echo "âš ï¸ ADMIN_S3_BUCKET not set, skipping"
            exit 0
          fi

          echo "ğŸ“¦ Deploying to s3://${S3_BUCKET}"

          # Versioned assets: long-lived cache
          aws s3 sync apps/frontend/dist "s3://${S3_BUCKET}" \
            --delete \
            --region "${{ env.AWS_REGION }}" \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          # HTML: always revalidate
          aws s3 cp apps/frontend/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --region "${{ env.AWS_REGION }}" \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8"

          echo "âœ… Admin frontend uploaded"

      - name: Invalidate CloudFront
        run: |
          DIST_ID="${{ vars.ADMIN_CF_DISTRIBUTION }}"
          if [ -z "$DIST_ID" ]; then
            echo "âš ï¸ ADMIN_CF_DISTRIBUTION not set, skipping"
            exit 0
          fi
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*" --region us-east-1
          echo "âœ… CloudFront invalidated"

  # â”€â”€â”€ Backend â†’ EC2 via SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_backend != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build workspace packages
        uses: ./.github/actions/build-packages

      - name: Build backend
        run: pnpm --filter @apps/backend build

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 120s
          script: |
            set -e
            echo "ğŸš€ Starting backend deployment..."

            cd /home/ec2-user/campaign-forge

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile

            echo "ğŸ”¨ Building packages and backend..."
            pnpm build:packages
            pnpm build:backend

            echo "â™»ï¸ Restarting backend with PM2..."
            pm2 restart campaign-forge-api || pm2 start apps/backend/dist/main.js \
              --name campaign-forge-api \
              --env production

            pm2 save

            echo "ğŸ¥ Health check..."
            sleep 3
            curl -f http://localhost:3001/api/health || echo "âš ï¸ Health check failed (may need a moment)"

            echo "âœ… Backend deployed"

  # â”€â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-landing, deploy-frontend, deploy-backend]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "Landing:  ${{ needs.deploy-landing.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Backend:  ${{ needs.deploy-backend.result }}"

          if [[ "${{ needs.deploy-landing.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-backend.result }}" == "failure" ]]; then
            echo "âŒ Deployment failed"
            exit 1
          else
            echo "âœ… All deployments complete"
          fi
