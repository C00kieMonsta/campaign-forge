name: Deploy Application

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
      deploy_infra:
        description: "Deploy infrastructure (CDK)"
        required: false
        default: false
        type: boolean
      deploy_landing:
        description: "Deploy landing site"
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: "Deploy admin frontend"
        required: false
        default: true
        type: boolean

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-1

jobs:
  # Stage 1: Deploy Infrastructure (optional, on-demand)
  deploy-infra:
    name: Deploy Infrastructure with CDK
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_infra == 'true'
    outputs:
      landing-bucket: ${{ steps.outputs.outputs.landing-bucket }}
      landing-distribution: ${{ steps.outputs.outputs.landing-distribution }}
      admin-bucket: ${{ steps.outputs.outputs.admin-bucket }}
      admin-distribution: ${{ steps.outputs.outputs.admin-distribution }}
      api-url: ${{ steps.outputs.outputs.api-url }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install CDK dependencies
        working-directory: ./infrastructure
        run: npm ci

      - name: Build CDK
        working-directory: ./infrastructure
        run: npm run build

      - name: Deploy all stacks
        working-directory: ./infrastructure
        run: npx cdk deploy --all --require-approval never
        env:
          CDK_DEFAULT_ACCOUNT: ${{ vars.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}

      - name: Capture CDK outputs
        id: outputs
        run: |
          echo "landing-bucket=${{ vars.LANDING_S3_BUCKET }}" >> $GITHUB_OUTPUT
          echo "landing-distribution=${{ vars.LANDING_CF_DISTRIBUTION }}" >> $GITHUB_OUTPUT
          echo "admin-bucket=${{ vars.ADMIN_S3_BUCKET }}" >> $GITHUB_OUTPUT
          echo "admin-distribution=${{ vars.ADMIN_CF_DISTRIBUTION }}" >> $GITHUB_OUTPUT
          echo "api-url=${{ vars.API_BASE_URL }}" >> $GITHUB_OUTPUT

  # Stage 2: Deploy Landing Site
  deploy-landing:
    name: Deploy Landing Site
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_landing != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build landing site
        run: pnpm --filter @apps/landing build
        env:
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_S3 }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_S3 }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy landing to S3
        run: |
          S3_BUCKET="${{ vars.LANDING_S3_BUCKET }}"
          
          if [ -z "$S3_BUCKET" ]; then
            echo "‚ö†Ô∏è LANDING_S3_BUCKET not set, skipping deploy"
            exit 0
          fi
          
          echo "üì¶ Deploying landing to S3: s3://${S3_BUCKET}"
          
          # Sync versioned assets with long cache
          aws s3 sync apps/landing/dist "s3://${S3_BUCKET}" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"
          
          # Upload HTML with no-cache
          aws s3 cp apps/landing/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8"
          
          echo "‚úÖ Landing assets uploaded"

      - name: Invalidate CloudFront
        run: |
          DIST_ID="${{ vars.LANDING_CF_DISTRIBUTION }}"
          
          if [ -z "$DIST_ID" ]; then
            echo "‚ö†Ô∏è LANDING_CF_DISTRIBUTION not set, skipping invalidation"
            exit 0
          fi
          
          echo "üîÑ Invalidating CloudFront: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*"
          echo "‚úÖ CloudFront invalidation requested"

  # Stage 3: Deploy Admin Frontend
  deploy-frontend:
    name: Deploy Admin Frontend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    if: github.event.inputs.deploy_frontend != 'false'
    steps:
      - uses: actions/checkout@v4

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env

      - name: Build workspace packages
        uses: ./.github/actions/build-packages

      - name: Build admin frontend
        run: pnpm --filter @apps/frontend build
        env:
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL }}
          VITE_COGNITO_DOMAIN: ${{ vars.COGNITO_DOMAIN }}
          VITE_COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}
          VITE_COGNITO_REDIRECT_URI: ${{ vars.COGNITO_REDIRECT_URI }}
          VITE_COGNITO_LOGOUT_URI: ${{ vars.COGNITO_LOGOUT_URI }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_S3 }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_S3 }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy admin to S3
        run: |
          S3_BUCKET="${{ vars.ADMIN_S3_BUCKET }}"
          
          if [ -z "$S3_BUCKET" ]; then
            echo "‚ö†Ô∏è ADMIN_S3_BUCKET not set, skipping deploy"
            exit 0
          fi
          
          echo "üì¶ Deploying admin frontend to S3: s3://${S3_BUCKET}"
          
          # Sync versioned assets with long cache
          aws s3 sync apps/frontend/dist "s3://${S3_BUCKET}" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"
          
          # Upload HTML with no-cache
          aws s3 cp apps/frontend/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html; charset=utf-8"
          
          echo "‚úÖ Admin assets uploaded"

      - name: Invalidate CloudFront
        run: |
          DIST_ID="${{ vars.ADMIN_CF_DISTRIBUTION }}"
          
          if [ -z "$DIST_ID" ]; then
            echo "‚ö†Ô∏è ADMIN_CF_DISTRIBUTION not set, skipping invalidation"
            exit 0
          fi
          
          echo "üîÑ Invalidating CloudFront: $DIST_ID"
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*"
          echo "‚úÖ CloudFront invalidation requested"

  # Summary
  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-landing, deploy-frontend]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Landing deploy: ${{ needs.deploy-landing.result }}"
          echo "Admin deploy: ${{ needs.deploy-frontend.result }}"
          echo ""
          
          if [[ "${{ needs.deploy-landing.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "‚ùå Deployment failed"
            exit 1
          else
            echo "‚úÖ Deployment complete"
          fi
